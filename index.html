<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parts Tracker Pro - Enhanced</title>
    <style>
        :root { --primary: #1a73e8; --bg: #f1f3f4; --danger: #d93025; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 500px; background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); box-sizing: border-box; }
        .section { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #e0e0e0; }
        input, button { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #dadce0; box-sizing: border-box; font-size: 1rem; }
        button { background: var(--primary); color: white; font-weight: bold; border: none; cursor: pointer; }
        .btn-clear { background: transparent; color: var(--danger); border: 1px solid var(--danger); margin-top: 20px; font-size: 0.8rem; padding: 8px; }
        .part-chip { display: inline-block; background: #3c4043; color: white; padding: 8px 14px; border-radius: 20px; margin: 4px; font-family: monospace; cursor: pointer; }
        .part-chip.used { background: #1e8e3e; text-decoration: line-through; opacity: 0.6; }
        #status-msg { text-align: center; color: #e67e22; font-weight: 500; margin: 10px 0; min-height: 1.2rem; }
        .page-block { border: 1px solid #dadce0; border-radius: 8px; margin-bottom: 12px; background: white; padding: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <h2 style="text-align:center; color:var(--primary); margin-top:0;">Parts Tracker Pro</h2>
    
    <div class="section">
        <label style="font-size:0.8rem; font-weight:bold;">1. API Key (Auto-Saved)</label>
        <input type="password" id="api-key" placeholder="Paste Gemini Key Here">
    </div>

    <div class="section">
        <label style="font-size:0.8rem; font-weight:bold;">2. Scan Image</label>
        <input type="number" id="page-number" placeholder="Page #" value="1">
        <input type="file" id="camera-input" accept="image/*" capture="environment">
        <button onclick="processImageAI()">ðŸ“· AI Vision Scan</button>
        <div id="status-msg">Ready</div>
    </div>

    <div id="display-area"></div>
    <button class="btn-clear" onclick="clearAll()">Reset App</button>
</div>

<script>
    let partsData = JSON.parse(localStorage.getItem('parts_tracker_v3')) || {};
    
    // Auto-load and Save Key
    const apiKeyInput = document.getElementById('api-key');
    apiKeyInput.value = localStorage.getItem('parts_tracker_api_key') || "";
    apiKeyInput.addEventListener('input', () => {
        localStorage.setItem('parts_tracker_api_key', apiKeyInput.value);
    });

    async function processImageAI() {
        const apiKey = apiKeyInput.value;
        const fileInput = document.getElementById('camera-input');
        const pageNum = document.getElementById('page-number').value || "1";
        const status = document.getElementById('status-msg');
        
        if (!apiKey) return alert("Please enter your API key.");
        if (!fileInput.files[0]) return alert("Please capture/select an image.");

        status.innerText = "âŒ› AI is thinking...";
        status.style.color = "#e67e22";
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const base64Data = e.target.result.split(',')[1];
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [
                            { text: "Locate all part identification codes in this image (e.g., A101, B-52). Return ONLY a JSON array of strings: [\"CODE1\", \"CODE2\"]. No other text." },
                            { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                        ]}]
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                // Robust JSON extraction
                let textResult = data.candidates[0].content.parts[0].text;
                const jsonMatch = textResult.match(/\[.*\]/s); 
                if (!jsonMatch) throw new Error("AI couldn't find any codes.");
                
                const codes = JSON.parse(jsonMatch[0]);

                if (!partsData[pageNum]) partsData[pageNum] = [];
                codes.forEach(c => {
                    if (!partsData[pageNum].find(i => i.code === c)) {
                        partsData[pageNum].push({ code: c, used: false });
                    }
                });

                localStorage.setItem('parts_tracker_v3', JSON.stringify(partsData));
                renderData();
                status.innerText = `âœ… Success: ${codes.length} found`;
                status.style.color = "#1e8e3e";
            } catch (err) {
                console.error("Full Error:", err);
                status.innerText = "âŒ Scan Failed: " + (err.message.includes("API key") ? "Invalid Key" : "Try again");
                status.style.color = "#d93025";
            }
        };
        reader.readAsDataURL(fileInput.files[0]);
    }

    function renderData() {
        const area = document.getElementById('display-area');
        area.innerHTML = "";
        const pages = Object.keys(partsData).sort((a,b) => a-b);
        if (pages.length === 0) area.innerHTML = "<p style='text-align:center; color:grey;'>No scans yet.</p>";
        
        pages.forEach(page => {
            const block = document.createElement('div');
            block.className = 'page-block';
            block.innerHTML = `<strong>Page ${page}</strong><br>`;
            partsData[page].forEach((item, index) => {
                const chip = document.createElement('span');
                chip.className = `part-chip ${item.used ? 'used' : ''}`;
                chip.innerText = item.code;
                chip.onclick = () => {
                    partsData[page][index].used = !partsData[page][index].used;
                    localStorage.setItem('parts_tracker_v3', JSON.stringify(partsData));
                    renderData();
                };
                block.appendChild(chip);
            });
            area.appendChild(block);
        });
    }

    function clearAll() {
        if(confirm("Delete everything?")) {
            localStorage.clear();
            location.reload();
        }
    }

    window.onload = renderData;
</script>
</body>
</html>