<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parts Tracker - Model Fix</title>
    <style>
        :root { --primary: #1a73e8; --bg: #f1f3f4; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 500px; background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); box-sizing: border-box; }
        .section { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #e0e0e0; }
        input, button { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #dadce0; box-sizing: border-box; font-size: 1rem; }
        button { background: var(--primary); color: white; font-weight: bold; border: none; cursor: pointer; }
        #status-msg { text-align: center; color: #d93025; font-size: 0.9rem; margin: 10px 0; white-space: pre-wrap; }
        .part-chip { display: inline-block; background: #3c4043; color: white; padding: 8px 14px; border-radius: 20px; margin: 4px; font-family: monospace; }
    </style>
</head>
<body>

<div class="app-container">
    <h2 style="text-align:center; color:var(--primary);">Parts Tracker Pro</h2>
    
    <div class="section">
        <label>1. API Key</label>
        <input type="password" id="api-key" placeholder="Paste Key Here">
    </div>

    <div class="section">
        <label>2. Vision Scan</label>
        <input type="number" id="page-number" value="1">
        <input type="file" id="camera-input" accept="image/*">
        <button onclick="processImageAI()">ðŸ“· Scan with Gemini 2.5</button>
        <div id="status-msg" style="color:#e67e22">Ready</div>
    </div>

    <div id="display-area"></div>
</div>

<script>
    let partsData = JSON.parse(localStorage.getItem('parts_tracker_v3')) || {};
    const apiKeyInput = document.getElementById('api-key');
    apiKeyInput.value = localStorage.getItem('parts_tracker_api_key') || "";
    apiKeyInput.addEventListener('input', () => localStorage.setItem('parts_tracker_api_key', apiKeyInput.value));

    async function processImageAI() {
        const apiKey = apiKeyInput.value;
        const fileInput = document.getElementById('camera-input');
        const status = document.getElementById('status-msg');
        
        if (!apiKey) return alert("Missing API Key!");
        if (!fileInput.files[0]) return alert("Select an image!");

        status.innerText = "âŒ› Scanning with Gemini 2.5 Flash...";
        status.style.color = "#e67e22";

        const reader = new FileReader();
        reader.onload = async (e) => {
            const base64Data = e.target.result.split(',')[1];
            
            // CHANGED: Using v1 (Stable) and gemini-2.5-flash
            const url = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [
                            { text: "Find all part codes in this image. Return ONLY a JSON array: ['CODE1', 'CODE2']." },
                            { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                        ]}]
                    })
                });

                const data = await response.json();

                if (data.error) {
                    status.innerText = `âŒ Error: ${data.error.message}\n(Try creating a new key at AI Studio)`;
                    status.style.color = "#d93025";
                    return;
                }

                const rawText = data.candidates[0].content.parts[0].text;
                const codes = JSON.parse(rawText.match(/\[.*\]/s)[0]);
                const pageNum = document.getElementById('page-number').value || "1";
                
                if (!partsData[pageNum]) partsData[pageNum] = [];
                codes.forEach(c => partsData[pageNum].push({ code: c, used: false }));
                
                localStorage.setItem('parts_tracker_v3', JSON.stringify(partsData));
                renderData();
                status.innerText = `âœ… Found ${codes.length} codes!`;
                status.style.color = "#1e8e3e";

            } catch (err) {
                status.innerText = "âŒ Scan failed. Please check the console.";
                console.error(err);
            }
        };
        reader.readAsDataURL(fileInput.files[0]);
    }

    function renderData() {
        const area = document.getElementById('display-area');
        area.innerHTML = "";
        Object.keys(partsData).sort((a,b) => a-b).forEach(page => {
            const block = document.createElement('div');
            block.className = 'page-block';
            block.innerHTML = `<strong>Page ${page}</strong><br>`;
            partsData[page].forEach(item => {
                const chip = document.createElement('span');
                chip.className = "part-chip";
                chip.innerText = item.code;
                block.appendChild(chip);
            });
            area.appendChild(block);
        });
    }
    window.onload = renderData;
</script>
</body>
</html>